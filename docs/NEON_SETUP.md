# Neon Setup (Serverless Postgres)

This guide shows how to wire Neon (serverless Postgres) into HotelSaver.ng with Prisma and Vercel.

## Why Neon
- Built-in connection pooling (great for Vercel serverless + Prisma)
- Fast provisioning and generous free tier
- Minimal ops overhead for our current use (PaymentIntent persistence)

## 1) Create a Neon project
1. Go to https://neon.tech and create a new project
2. Create a database (default `neondb` is fine) and user
3. In Connection Details, copy a **pooled** connection string
   - It often looks like: `postgresql://USER:PASSWORD@POOL-HOST:PORT/DB?sslmode=require`

## 2) Configure environment variables

Local `.env` (use `.env.example` as a template):
```
DATABASE_URL="postgresql://USER:PASSWORD@POOL-HOST:PORT/DB?sslmode=require"
PAYSTACK_SECRET_KEY="sk_test_xxx"
```

Vercel → Project Settings → Environment Variables (Production):
- Add `DATABASE_URL` with the pooled Neon URL
- Add `PAYSTACK_SECRET_KEY`
- Redeploy the app

Notes:
- Prisma Client is generated by `postinstall` during the build
- Keep `sslmode=require` when Neon requires SSL

## 3) Apply Prisma schema to Neon
From your local machine:

```bash
export DATABASE_URL="postgresql://USER:PASSWORD@POOL-HOST:PORT/DB?sslmode=require"

# Apply existing migrations
npx prisma migrate deploy
```

If you don’t have an initial migration yet, create one locally (dev DB) first:
```
npx prisma migrate dev --name init
```
Commit the migration and then run `prisma migrate deploy` against Neon as above.

## 4) Smoke test the database
We ship a tiny smoke test that creates a PaymentIntent row.

```bash
export DATABASE_URL="postgresql://USER:PASSWORD@POOL-HOST:PORT/DB?sslmode=require"
npm run db:smoke
```

Expected output:
- Created PaymentIntent: <id> <reference>
- Verified PaymentIntent fetch OK

## 5) (Optional) Seed hotels into DB
You can keep hotels/services on JSON for now. If/when you move reads to DB:

```bash
export DATABASE_URL="postgresql://USER:PASSWORD@POOL-HOST:PORT/DB?sslmode=require"
npx prisma migrate deploy
npm run db:seed
```

The seed uses `lib.hotels.json`, maps cities to Prisma enums, and creates `Hotel` + `HotelImage` rows. It preserves JSON `id` as the hotel `slug` when possible.

## 6) Checklist & Pitfalls
- Use a **pooled** connection URL to avoid connection exhaustion on serverless
- Keep `sslmode=require` if Neon enforces SSL
- Ensure Prisma Client is generated (`postinstall` takes care of this on Vercel)
- Grant least-privilege DB access for production
- Enable Neon backups and review retention

## 7) Verify end-to-end (payments)
- Run a Paystack sandbox payment
- Confirm `PaymentIntent` row updates to `PAID` (via verify/webhook)
- Check logs for connection or timeout errors

## References
- Prisma schema: `prisma/schema.prisma`
- Production guide: `PRODUCTION_READINESS.md` (Appendix)
- Payment setup: `docs/PAYMENT_SETUP.md`
